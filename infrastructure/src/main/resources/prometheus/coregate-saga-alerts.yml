groups:
  - name: coregate-saga-alerts
    interval: 15s
    rules:
      # üö® Alta taxa de Rollbacks (>5% das transa√ß√µes nos √∫ltimos 10 min)
      - alert: HighRollbackRate
        expr: |
          (
            sum(rate(coregate_saga_rollback_total[10m]))
            /
            (sum(rate(coregate_transaction_success_total[10m])) + sum(rate(coregate_transaction_failure_total[10m])))
          ) > 0.05
        for: 2m
        labels:
          severity: warning
          service: coregate
        annotations:
          summary: "Alta taxa de rollback detectada (>5%)"
          description: "Tenant(s) com rollback excessivo. Verificar logs e erros do Saga Orquestrator."

      # üö® Lat√™ncia de transa√ß√µes acima do P95 definido (500ms)
      - alert: HighTransactionLatency
        expr: |
          histogram_quantile(0.95, sum(rate(coregate_transaction_duration_ms_bucket[5m])) by (le, tenant)) > 0.5
        for: 1m
        labels:
          severity: critical
          service: coregate
        annotations:
          summary: "Transa√ß√µes lentas detectadas (P95 > 500ms)"
          description: "A lat√™ncia m√©dia das transa√ß√µes ultrapassou o limite. Verifique gargalos de processamento."

      # ‚ö†Ô∏è Falhas de Step acima de 10% das execu√ß√µes
      - alert: HighSagaStepFailures
        expr: |
          (
            sum(rate(coregate_saga_step_failed_total[10m]))
            /
            (sum(rate(coregate_saga_step_executed_total[10m])) + 1)
          ) > 0.1
        for: 3m
        labels:
          severity: warning
          service: coregate
        annotations:
          summary: "Falhas em steps da Saga acima de 10%"
          description: "Verificar quais steps est√£o falhando com maior frequ√™ncia nos √∫ltimos 10 minutos."

      # ‚ö†Ô∏è Baixo throughput de transa√ß√µes (TPS < 1)
      - alert: LowTransactionRate
        expr: |
          avg(coregate_tps_per_tenant) < 1
        for: 5m
        labels:
          severity: info
          service: coregate
        annotations:
          summary: "Baixo volume de transa√ß√µes"
          description: "A taxa de TPS caiu abaixo de 1 por tenant. Pode indicar ambiente ocioso ou problema de ingest√£o."
